#!/init <

mt /proc /proc proc rw

# check for a pre-mounted devtmpfs or create some nodes
td
|{
bl 0600 0 0 3 0 hd[c,ab,64][I,0-16,1]
bl 0600 0 0 22 0 hd[c,cd,64][I,0-16,1]
bl 0600 0 0 33 0 hd[c,ef,64][I,0-16,1]
bl 0600 0 0 8 0 sd[c,a-h,16][I,0-15,1]
md /dev/rd 755		# DAC960 raid disks (majors 48-55)
bl 0600 0 0 48 0 rd/c0d[i,0-31,8]
bl 0600 0 0 48 1 rd/c0d[i,0-31,8]p[i,1-7,1]
md /dev/ida 755		# Compaq raid disks (majors 72-79)
bl 0600 0 0 72 0 ida/c0d[i,0-15,16]
bl 0600 0 0 72 1 ida/c0d[i,0-15,16]p[i,1-15,1]
md /dev/cciss 755       # Compaq CCISS raid disks (major 104)
bl 0600 0 0 104 0 cciss/c0d[i,0-15,16]
bl 0600 0 0 104 1 cciss/c0d[i,0-15,16]p[i,1-15,1]
ch 0600 0 0 90 0 mtd[i,0-15,2]
bl 0600 0 0 31 0 mtdblock[i,0-15,1]
bl 0600 0 0 179 0 mmcblk[i,0-31,8]
bl 0600 0 0 179 1 mmcblk[i,0-31,8]p[i,1-7,1]
bl 0600 0 0 11 0 sr[i,0-16,1]
ch 0600 0 0 9 0 st[i,0-15,1]
bl 0600 0 0 9 0 md[i,0-15,1]
bl 0600 0 0 2 0 fd0
bl 0600 0 0 2 28 fd0u1440
ch 0600 0 5 2 0 pty[c,p-za-f,16][h,0-f,1]
ch 0600 0 5 3 0 tty[c,p-za-f,16][h,0-f,1]
ch 0600 0 5 4 1 tty[i,1-12,1]
bl 0600 0 0 7 0 loop[i,0-9,1]
bl 0600 0 0 1 0 ram[i,0-9,1]
ch 0600 0 5 4 64 ttyS[i,0-9,1]
ch 0600 0 0 10 144 nvram
ch 0600 0 0 10 130 watchdog
ch 0600 0 0 10 135 rtc
bl 0400 0 0 1 250 initrd
}

# 3 boot methods are supported:
#  - initrd present: run it r/o and ignore $root
#  - root specified: mount it ro or rw optionally with $rootfstype
#  - kernel only with $img: try to locate the image and run it
#  - otherwise drop to a shell
cp /initrd.image /dev/ram0
&{
  rm /initrd.image
  ec "Mounting initrd image ..."
  mt /dev/ram0 /root auto ro
}
|{
  tn ${root}
  &{
    # mount the root device with the ro/rw flags as specified on the cmdline
    # and if it fails, try to force load /dev/ram0 as squashfs
    tn ${rootdelay}
    &{
      ec "Waiting "${rootdelay}" seconds for root to appear ..."
      sl ${rootdelay}
    }
    ec "Mounting "${root}" on / ..."
    mt ${root} /root ${rootfstype-auto} ${ro+ro} ${rw+rw}
  }
  |{
    tn ${img}
    &{
      # try to load an XIP image (read-only)
      tn ${rootdelay}
      &{
        ec "Waiting "${rootdelay}" seconds for root to appear ..."
        sl ${rootdelay}
      }
      fp ${img} squashfs squashfs3 xfs ext4 ext3 ext2
      tn ${chosen_type}
      &ec "Mounting "${chosen_part}" on / ..."
      &mt ${chosen_part} /root ${chosen_type} ro
      |{
        tn ${chosen_type}
        &ec "Failed to mount "${chosen_part}" as type "${chosen_type}", falling back to "${second_part}
        tn ${second_type}
        &ec "Mounting "${second_part}" on / ..."
        &mt ${second_part} /root ${second_type} ro
      }
    }
  }
}
|{
  ec "+-----------------------------------------------+"
  ec "| Failed to mount any initrd or root device.    |"
  ec "| Rebooting in 3 seconds unless Enter pressed.  |"
  wk "+-----------------------------------------------+" 3
  |rb
  md /tmp
  md /bin
  md /boot
  md /sbin
  md /usr/bin
  md /usr/sbin
  md /lib/modules
  st /modules.tar
  &{
    ec "Extracting modules into /lib/modules ..."
    mt modules /lib/modules/. ramfs rw
    ta x /modules.tar /lib/modules
  }
  st /busybox
  &{
    ec "Trying to unpack /busybox ..."
    /busybox --install
  }
  ec "Entering interactive debugging, type 'help' for supported commands."
  ec "Use 'lp' and 'fp' to find devices mountable into /root, 'en' for env."
  rd "Mount using 'mt /dev/xxx /root <fstype>|auto [options]'."
  um /lib/modules/.
}

st /modules.tar
&{
  st /root/lib/modules/.
  &{
    mt initramfs /root/lib/modules/. ramfs rw
    ec "Extracting modules into /lib/modules ..."
    ta x /modules.tar /root/lib/modules
  }
  |{
    st /root/boot/.
    &{
      mt initramfs /root/boot/. ramfs rw
      ec "Extracting modules into /boot ..."
      ta x /modules.tar /root/boot
    }
    |ec "WARNING: no /boot or /lib/modules directory to extract modules into!"
  }
  rm /modules.tar
}
|ec "No modules found in initramfs."

te RDSHELL=1
&rd "You have requested this prompt by appending RDSHELL=1 to the kernel command line."

# last cleanup
rm /.preinit
rm /init
um /proc
rm /proc
um /dev
# only two entries left: /dev and /root

ec "Switching to rootfs ..."
cd /root
mv . /
sw .

# check if we want to use $init, /sbin/init, /bin/init, /init or /linuxrc
st ${init-/sbin/init}
  &in ${init-/sbin/init}
|{
  st /sbin/init
  &in /sbin/init
  |{
    st /bin/init
    &in /bin/init
    |{
      st /init
      &in /init
      |{
        st /linuxrc
        &in /linuxrc
      }
    }
  }
}
|{
  ec "No init or linuxrc found, falling back to /bin/sh."
  br /bin/sh
  ec "Failed to execute /bin/sh, falling back to init prompt."
  rd
}
